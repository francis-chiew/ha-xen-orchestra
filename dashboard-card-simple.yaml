# üñ•Ô∏è Xen Orchestra Dashboard - Portable Version
# 
# This dashboard automatically detects your Xen Orchestra integration!
# No need to configure integration IDs - works on any Home Assistant installation.
#
# REQUIREMENTS:
# - Xen Orchestra custom integration installed
# - auto-entities card (HACS)
# - mushroom cards (HACS)
#
# SETUP INSTRUCTIONS:
# 1. Install required custom cards via HACS
# 2. Copy this entire YAML content
# 3. Paste into your Home Assistant dashboard
# 4. Save - it will automatically detect your Xen Orchestra entities!
#
# SAFETY FEATURES:
# - XOA and Home Assistant VMs excluded from emergency controls
# - Prevents accidental shutdown of critical infrastructure

type: vertical-stack
cards:
  # Header with Instructions
  - type: markdown
    content: |
      # üñ•Ô∏è Xen Orchestra Infrastructure
      **Auto-detected** - No configuration required!
      
  # Host Resources Section
  - type: custom:auto-entities
    card:
      type: entities
      title: "üñ•Ô∏è Host Resources"
    filter:
      include:
        # Match any CPU usage sensor (filters to Xen Orchestra automatically)
        - domain: sensor
          entity_id: "*cpu_usage*"
          options:
            type: custom:mushroom-template-card
            primary: |
              {% set host_name = state_attr(entity, 'friendly_name').replace(' CPU Usage', '') %}
              üñ•Ô∏è {{ host_name }}
            secondary: |
              {% set cpu_entity = entity %}
              {% set memory_entity = cpu_entity.replace('cpu_usage', 'memory_usage') %}
              {% set cpu = states(cpu_entity) | float(0) %}
              {% set memory = states(memory_entity) | float(0) %}
              üíæ CPU: {{ cpu }}% | üß† RAM: {{ memory }}%
            icon: mdi:server
            icon_color: |
              {% set cpu = states(entity) | float(0) %}
              {% if cpu > 80 %}red
              {% elif cpu > 60 %}orange
              {% else %}green
              {% endif %}
            badge_icon: |
              {% set memory_entity = entity.replace('cpu_usage', 'memory_usage') %}
              {% set memory = states(memory_entity) | float(0) %}
              {% if memory > 80 %}mdi:alert
              {% else %}""
              {% endif %}
            badge_color: |
              {% set memory_entity = entity.replace('cpu_usage', 'memory_usage') %}
              {% set memory = states(memory_entity) | float(0) %}
              {% if memory > 80 %}red
              {% else %}""
              {% endif %}
            multiline_secondary: true
            tap_action:
              action: more-info
            hold_action:
              action: more-info
    sort:
      method: friendly_name

  # Virtual Machines Section
  - type: custom:auto-entities
    card:
      type: entities
      title: "üíª Virtual Machines"
    filter:
      include:
        # Match devices with "Virtual Machine" model (most precise filter)
        - domain: switch
          device_model: Virtual Machine
          options:
            secondary_info: state
      exclude:
        # Safety: Exclude critical VMs from power controls
        - entity_id: "*xoa*"
        - entity_id: "*home*assistant*"
        - entity_id: "*homeassistant*"
    sort:
      method: friendly_name

  # Emergency Controls Section
  - type: markdown
    content: |
      ### üö® Emergency Controls
      ‚ö†Ô∏è **Warning:** Hard shutdown forces VM power off without graceful shutdown
      
  - type: custom:auto-entities
    card:
      type: entities
      title: "üö® Emergency Controls"
    filter:
      include:
        # Match devices with "Virtual Machine" model
        - domain: button
          device_model: Virtual Machine
      exclude:
        # Safety: Exclude critical VMs from emergency controls
        - entity_id: "*xoa*"
        - entity_id: "*home*assistant*"
        - entity_id: "*homeassistant*"
    sort:
      method: friendly_name

  # Infrastructure Summary Section
  - type: horizontal-stack
    cards:
      # VM Count Summary
      - type: custom:mushroom-template-card
        primary: "Virtual Machines"
        secondary: |
          {% set vm_switches = states.switch | selectattr('attributes.device_info', 'defined') | selectattr('attributes.device_info.model', 'eq', 'Virtual Machine') | list %}
          {% set running = vm_switches | selectattr('state', 'eq', 'on') | list | length %}
          {% set total = vm_switches | length %}
          {{ running }} running / {{ total }} total
        icon: mdi:server-network
        icon_color: |
          {% set vm_switches = states.switch | selectattr('attributes.device_info', 'defined') | selectattr('attributes.device_info.model', 'eq', 'Virtual Machine') | list %}
          {% set running = vm_switches | selectattr('state', 'eq', 'on') | list | length %}
          {% set total = vm_switches | length %}
          {% if total == 0 %}grey
          {% elif running == total %}green
          {% elif running > 0 %}orange
          {% else %}red
          {% endif %}
        tap_action:
          action: none
          
      # Average CPU Summary
      - type: custom:mushroom-template-card
        primary: "Average CPU"
        secondary: |
          {% set cpu_sensors = states.sensor | selectattr('entity_id', 'search', '_cpu_usage$') | list %}
          {% if cpu_sensors | length > 0 %}
            {% set cpu_values = cpu_sensors | map(attribute='state') | map('float', 0) | list %}
            {% set avg_cpu = (cpu_values | sum / cpu_values | length) | round(1) %}
            {{ avg_cpu }}%
          {% else %}
            N/A
          {% endif %}
        icon: mdi:cpu-64-bit
        icon_color: |
          {% set cpu_sensors = states.sensor | selectattr('entity_id', 'search', '_cpu_usage$') | list %}
          {% if cpu_sensors | length > 0 %}
            {% set cpu_values = cpu_sensors | map(attribute='state') | map('float', 0) | list %}
            {% set avg_cpu = cpu_values | sum / cpu_values | length %}
            {% if avg_cpu > 80 %}red
            {% elif avg_cpu > 60 %}orange
            {% else %}green
            {% endif %}
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
          
      # Average Memory Summary
      - type: custom:mushroom-template-card
        primary: "Average RAM"
        secondary: |
          {% set mem_sensors = states.sensor | selectattr('entity_id', 'search', '_memory_usage$') | list %}
          {% if mem_sensors | length > 0 %}
            {% set mem_values = mem_sensors | map(attribute='state') | map('float', 0) | list %}
            {% set avg_mem = (mem_values | sum / mem_values | length) | round(1) %}
            {{ avg_mem }}%
          {% else %}
            N/A
          {% endif %}
        icon: mdi:memory
        icon_color: |
          {% set mem_sensors = states.sensor | selectattr('entity_id', 'search', '_memory_usage$') | list %}
          {% if mem_sensors | length > 0 %}
            {% set mem_values = mem_sensors | map(attribute='state') | map('float', 0) | list %}
            {% set avg_mem = mem_values | sum / mem_values | length %}
            {% if avg_mem > 80 %}red
            {% elif avg_mem > 60 %}orange
            {% else %}green
            {% endif %}
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none

  # Footer with Credits
  - type: markdown
    content: |
      ---
      **Xen Orchestra Dashboard** | Auto-detects integration | No config required
      Made with ‚ù§Ô∏è for the Home Assistant community